/*!
 * VERSION: 0.1.0
 * DATE: 2015-09-24
 * GIT:https://github.com/shrekshrek/image-uploader
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["exif","exports"],function(a,n){e.ImgUper=t(e,n,a)});else if("undefined"!=typeof exports){var a=require("exif");t(e,exports,a)}else e.ImgUper=t(e,{},e.EXIF)}(function(t,e,a){function n(){var t=navigator.userAgent;return{ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),iosv:t.substr(t.indexOf("iPhone OS")+9,3)}}function i(t,e){for(var a in e)t[a]=e[a]}function c(t){if(!t)throw"target is undefined, can't tween!!!";return"string"==typeof t?"undefined"==typeof document?t:document.querySelectorAll?document.querySelectorAll(t):document.getElementById("#"===t.charAt(0)?t.substr(1):t):t}return e=function(){this.init.apply(this,arguments)},i(e.prototype,{init:function(t){var e=t||{};this.el=e.el?c(e.el)[0]:function(){var t=document.createElement("INPUT");return t.setAttribute("type","file"),t.setAttribute("accept","image/*"),t.setAttribute("capture","camera"),t}(),this.size=e.size||500,this.type=e.type||"jpeg",this.quality=e.quality||.7,this.ua=n(),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.el.addEventListener("change",this.change.bind(this),!1)},change:function(t){var e=this,n=t.target.files[0];if(void 0!=n){var i,c,r,s,o,l;window.URL=window.URL||window.webkitURL;var h=window.URL.createObjectURL(n),u=new Image;u.src=h,u.onload=function(){a.getData(u,function(){var t=a.getTag(this,"Orientation")||0;switch(i=u.width,s=u.height,i>=s?(c=e.size,o=c*s/i,r=i,l=s):(o=e.size,c=o*i/s,r=s,l=i),t){case 3:e.canvas.width=c,e.canvas.height=o,e.ctx.clearRect(0,0,c,o),e.ctx.translate(c/2,o/2),e.ctx.rotate(180*Math.PI/180);break;case 6:e.canvas.width=o,e.canvas.height=c,e.ctx.clearRect(0,0,o,c),e.ctx.translate(o/2,c/2),e.ctx.rotate(90*Math.PI/180);break;case 8:e.canvas.width=o,e.canvas.height=c,e.ctx.clearRect(0,0,o,c),e.ctx.translate(o/2,c/2),e.ctx.rotate(270*Math.PI/180);break;default:e.canvas.width=c,e.canvas.height=o,e.ctx.clearRect(0,0,c,o),e.ctx.translate(c/2,o/2)}r>3260||l>2440?e.ua.ios?8==parseInt(e.ua.iosv)?e.ctx.drawImage(u,0,0,i,s,-c/2,-o/2,c,o):e.ctx.drawImage(u,0,0,i/2,s/2,-c/2,-o/2,c,o):e.ctx.drawImage(u,0,0,i,s,-c/2,-o/2,c,o):e.ctx.drawImage(u,-c/2,-o/2,c,o),e.completeHandler&&e.completeHandler.call(this,e.canvas.toDataURL("image/"+e.type,e.quality))})}}},handler:function(t){this.completeHandler=t},select:function(){this.el.click()},destroy:function(){this.el.removeEventListener("change",this.change,!1),delete this}}),e});
