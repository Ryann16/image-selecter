/*!
 * VERSION: 0.1.0
 * DATE: 2015-09-24
 * GIT:https://github.com/shrekshrek/image-uploader
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(e){var t="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["exif","exports"],function(i,a){t.ImgSlter=e(t,a,i)});else if("undefined"!=typeof exports){var i=require("exif");e(t,exports,i)}else t.ImgSlter=e(t,{},t.EXIF)}(function(e,t,i){function a(){var e=navigator.userAgent;return{ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),iosv:e.substr(e.indexOf("iPhone OS")+9,3)}}function n(e,t){for(var i in t)e[i]=t[i]}function c(e){if(!e)throw"target is undefined, can't tween!!!";return"string"==typeof e?"undefined"==typeof document?e:document.querySelectorAll?document.querySelectorAll(e):document.getElementById("#"===e.charAt(0)?e.substr(1):e):e}return t=function(){this.init.apply(this,arguments)},n(t.prototype,{init:function(e){var t=this,i=e||{};this.el=i.el?c(i.el)[0]:function(){var e=document.createElement("INPUT");return e.type="file",e.accept="image/*",e.capture="camera",e}(),this.size=i.size||500,this.type=i.type||"jpeg",this.quality=i.quality||.7,this.ua=a(),this.cvs=document.createElement("canvas"),this.ctx=this.cvs.getContext("2d"),this.changeHandler=function(e){t.change(e)},this.el.addEventListener("change",this.changeHandler,!1),this.handler=null},change:function(e){var t=this,a=e.target.files[0];if(void 0!=a){var n,c,s,r,l,h;window.URL=window.URL||window.webkitURL;var o=window.URL.createObjectURL(a),d=new Image;d.src=o,d.onload=function(){i.getData(d,function(){var e=i.getTag(this,"Orientation")||0;switch(n=d.width,r=d.height,n>=r?(c=t.size,l=c*r/n,s=n,h=r):(l=t.size,c=l*n/r,s=r,h=n),e){case 3:t.cvs.width=c,t.cvs.height=l,t.ctx.clearRect(0,0,c,l),t.ctx.translate(c/2,l/2),t.ctx.rotate(180*Math.PI/180);break;case 6:t.cvs.width=l,t.cvs.height=c,t.ctx.clearRect(0,0,l,c),t.ctx.translate(l/2,c/2),t.ctx.rotate(90*Math.PI/180);break;case 8:t.cvs.width=l,t.cvs.height=c,t.ctx.clearRect(0,0,l,c),t.ctx.translate(l/2,c/2),t.ctx.rotate(270*Math.PI/180);break;default:t.cvs.width=c,t.cvs.height=l,t.ctx.clearRect(0,0,c,l),t.ctx.translate(c/2,l/2)}s>3260||h>2440?t.ua.ios?parseInt(t.ua.iosv)>=8?t.ctx.drawImage(d,0,0,n,r,-c/2,-l/2,c,l):t.ctx.drawImage(d,0,0,n/2,r/2,-c/2,-l/2,c,l):t.ctx.drawImage(d,0,0,n,r,-c/2,-l/2,c,l):t.ctx.drawImage(d,-c/2,-l/2,c,l),t.handler&&t.handler.call(this,{img:t.cvs.toDataURL("image/"+t.type,t.quality),width:t.cvs.width,height:t.cvs.height})})}}},select:function(){this.el&&this.el.click()},destroy:function(){this.el.removeEventListener("change",this.changeHandler,!1),delete this.ua,delete this.ctx,delete this.cvs,delete this.el}}),t});
